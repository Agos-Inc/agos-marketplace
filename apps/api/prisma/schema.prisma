generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Service {
  serviceId      String   @id @map("service_id")
  serviceIdHex   String   @map("service_id_hex")
  name           String
  description    String
  inputSchema    Json     @map("input_schema")
  outputSchema   Json     @map("output_schema")
  priceUsdt      String   @map("price_usdt")
  priceAtomic    String   @map("price_atomic")
  tokenDecimals  Int      @default(18) @map("token_decimals")
  endpoint       String
  supplierWallet String   @map("supplier_wallet")
  version        String   @default("1.0.0")
  isActive       Boolean  @default(true) @map("is_active")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")
  orders         Order[]

  @@index([isActive, createdAt], map: "services_active_created_at_idx")
  @@map("services")
}

model Order {
  orderId        String   @id @map("order_id")
  orderIdHex     String   @map("order_id_hex")
  serviceId      String   @map("service_id")
  serviceIdHex   String   @map("service_id_hex")
  buyerWallet    String   @map("buyer_wallet")
  supplierWallet String   @map("supplier_wallet")
  amountUsdt     String   @map("amount_usdt")
  amountAtomic   String   @map("amount_atomic")
  tokenDecimals  Int      @default(18) @map("token_decimals")
  tokenAddress   String   @map("token_address")
  chainId        Int      @map("chain_id")
  status         String
  inputPayload   Json     @map("input_payload")
  resultPayload  Json?    @map("result_payload")
  errorMessage   String?  @map("error_message")
  txHash         String?  @map("tx_hash")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  service Service @relation(fields: [serviceId], references: [serviceId])

  @@index([status, createdAt], map: "orders_status_created_at_idx")
  @@index([serviceId, createdAt], map: "orders_service_id_created_at_idx")
  @@index([orderIdHex], map: "orders_order_id_hex_idx")
  @@map("orders")
}

model PaymentEvent {
  id          BigInt   @id @default(autoincrement())
  orderId     String   @map("order_id")
  orderIdHex  String   @map("order_id_hex")
  txHash      String   @map("tx_hash")
  blockNumber BigInt   @map("block_number")
  logIndex    Int      @map("log_index")
  rawEventJson Json    @map("raw_event_json")
  createdAt   DateTime @default(now()) @map("created_at")

  @@unique([txHash, logIndex], map: "payment_events_tx_hash_log_index_key")
  @@index([orderId], map: "payment_events_order_id_idx")
  @@map("payment_events")
}

model CallbackNonce {
  nonce     String   @id
  createdAt DateTime @default(now()) @map("created_at")

  @@map("callback_nonces")
}
